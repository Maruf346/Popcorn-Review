<!DOCTYPE html>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<html lang="en">
<head>
    <title>{{ movie.title }} - Movie Details</title>
</head>
<body>
    <h1>{{ movie.title }}</h1>
    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }} poster" width="300" height="450">
    <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
    <p><strong>Overview:</strong> {{ movie.overview }}</p>

    <h2>Average Rating: {{ avg_rating }}</h2>

    <!-- Review Form -->
    <h3>Leave a Review:</h3>
    <form method="post" action="">
        {% csrf_token %}
        <label for="rating">Rating (1-5):</label>
        <input type="number" name="rating" id="rating" min="1" max="5" required><br>
        
        <label for="review">Your Review:</label><br>
        <textarea name="review_text" id="review" rows="4" required></textarea><br>
        
        <button type="submit">Submit Review</button>
    </form>

    <!-- Display Reviews -->
    <h3>Reviews:</h3>
    {% if reviews %}
        {% for review in reviews %}
            <p><strong>{{ review.user.username }}</strong> (Rated: {{ review.rating }}/5):</p>
            <p>{{ review.review_text }}</p>
            <!-- Like and Dislike Buttons -->
            <button onclick="vote('like', {{ review.id }})">👍 Like (<span id="like-count-{{ review.id }}">{{ review.likes }}</span>)</button>
            <button onclick="vote('dislike', {{ review.id }})">👎 Dislike (<span id="dislike-count-{{ review.id }}">{{ review.dislikes }}</span>)</button>

            <hr>
        {% endfor %}
    {% else %}
        <p>No reviews yet. Be the first to review!</p>
    {% endif %}

    <!-- JavaScript for Like/Dislike -->
    <script>
        function vote(type, reviewId) {
            fetch(`/api/vote/${reviewId}/${type}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else if (data.message) {
                    alert(data.message);
                } else {
                    document.getElementById(`like-count-${reviewId}`).innerText = data.likes;
                    document.getElementById(`dislike-count-${reviewId}`).innerText = data.dislikes;
                }
            });
        }
    </script>
</body>
</html>
